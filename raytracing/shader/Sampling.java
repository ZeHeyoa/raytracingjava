package raytracing.shader;

import processing.core.PVector;

public class Sampling {

  static final int maxBits = 31;

  public static float Sobol(int n2, int D, int scramble) {
    long n = n2;
    long r = (long) scramble;
    for (int idx = D * maxBits; n != 0; idx++) {
      if ((n & 0x1L) != 0L)
        r ^= SobolMatrices[idx];
      n >>= 1;
    }
    r = (r & 0xFFFFFFFFL);

    return ((float) r) / ((float) 0x100000000L);
  }

  public static PVector to_unit_disk(float seedx, float seedy) {
    float phi, r;
    float a = (float) (2. * seedx - 1.); /* (a,b) is now on [-1,1]^2 */
    float b = (float) (2. * seedy - 1.);
    if (a > -b) { /* region 1 or 2 */
      if (a > b) { /* region 1, also |a| > |b| */
        r = a;
        phi = (float) ((Math.PI * 1. / 4) * (b / a));
      } else { /* region 2, also |b| > |a| */
        r = b;
        phi = (float) ((Math.PI * 1. / 4) * (2 - (a / b)));
      }
    } else { /* region 3 or 4 */
      if (a < b) { /* region 3, also |a| >= |b|, a != 0 */
        r = -a;
        phi = (float) ((Math.PI * 1. / 4) * (4 + (b / a)));
      } else { /* region 4, |b| >= |a|, but a==0 and b==0 could occur. */
        r = -b;
        if (b != 0)
          phi = (float) ((Math.PI * 1. / 4) * (6 - (a / b)));
        else
          phi = 0;
      }
    }
    float x = (float) (r * Math.cos(phi));
    float y = (float) (r * Math.sin(phi));
    float z = (float) Math.sqrt(1. - x * x - y * y);
    return new PVector(x, z, y); //
  }

  public static float VanDerCorput(int n2, int scramble) {
    long n = (long) n2;
    long sc = (long) scramble;
    n = (n << 16L) | (n >> 16L);
    n = ((n & 0x00ff00ffL) << 8L) | ((n & 0xff00ff00L) >> 8L);
    n = ((n & 0x0f0f0f0fL) << 4L) | ((n & 0xf0f0f0f0L) >> 4L);
    n = ((n & 0x33333333L) << 2L) | ((n & 0xccccccccL) >> 2L);
    n = ((n & 0x55555555L) << 1L) | ((n & 0xaaaaaaaaL) >> 1L);
    n ^= sc;
    n = (n & 0xFFFFFFFFL);
    return (float) n / ((float) ((long) 0x100000000L));
  }

  public static float Sobol2(int n2, int r2) {
    long n = n2;
    long r = r2;
    for (long v = 1 << 31L; n != 0L; n >>= 1L, v ^= v >> 1L)
      if ((n & 0x1L) != 0)
        r ^= v;
    r = (r & 0xFFFFFFFFL);
    return ((float) r) / ((float) 0x100000000L);
  }

  public static float[] QMC(int sc, int rx, int ry) {
    float samples[] = new float[2];
    samples[0] = Sobol2(sc, rx);
    samples[1] = VanDerCorput(sc / 2, ry);
    return samples;
  }

  public static long SobolMatrices[] = { 2147483648L, 3221225472L, 1610612736L, 805306368L, 402653184L, 201326592L,
      100663296L, 50331648L, 25165824L, 12582912L, 6291456L, 3145728L, 1572864L, 786432L, 393216L, 196608L,
      98304L, 49152L, 24576L, 12288L, 6144L, 3072L, 1536L, 768L, 384L, 192L, 96L, 48L, 24L, 12L, 6L, 2147483648L,
      1073741824L, 1610612736L, 1342177280L, 2013265920L, 1140850688L, 1711276032L, 1426063360L, 2139095040L,
      1077936128L, 1616904192L, 1347420160L, 2021130240L, 1145307136L, 1717960704L, 1431633920L, 2147450880L,
      1073758208L, 1610637312L, 1342197760L, 2013296640L, 1140868096L, 1711302144L, 1426085120L, 2139127680L,
      1077952576L, 1616928864L, 1347440720L, 2021161080L, 1145324612L, 1717986918L, 2147483648L, 3221225472L,
      2684354560L, 1342177280L, 3623878656L, 2617245696L, 1912602624L, 3372220416L, 2810183680L, 1556086784L,
      3533701120L, 2572156928L, 2136473600L, 3227254784L, 2698117120L, 1352204288L, 3632234496L, 2629877760L,
      1923129344L, 3377483776L, 2807617536L, 1549573120L, 3537007104L, 2576992512L, 2147428224L, 3221265600L,
      2684383904L, 1342228816L, 3623921496L, 2617269340L, 1912656594L, 2147483648L, 3221225472L, 1610612736L,
      4026531840L, 3087007744L, 2617245696L, 1442840576L, 855638016L, 3649044480L, 1874853888L, 3974103040L,
      2909798400L, 2396520448L, 1544290304L, 906362880L, 3272540160L, 1636532224L, 4090085376L, 3135594496L,
      2658349056L, 1465227264L, 868940800L, 3672690176L, 1853216512L, 4015746432L, 2948595904L, 2363490400L,
      1567621360L, 920125624L, 3222012060L, 1611006038L, 2147483648L, 1073741824L, 3758096384L, 2415919104L,
      3623878656L, 603979776L, 2785017856L, 1694498816L, 1166016512L, 4148166656L, 2665480192L, 3553624064L,
      980942848L, 3074686976L, 2129526784L, 1138294784L, 3799351296L, 2470854656L, 3638845440L, 652169216L,
      2817644544L, 1678324736L, 1175293440L, 4110576896L, 2643099520L, 3544596544L, 954491104L, 3068088464L,
      2146556120L, 1074344996L, 3758984870L, 2147483648L, 1073741824L, 536870912L, 4026531840L, 1476395008L,
      1677721600L, 3523215360L, 2801795072L, 964689920L, 2956984320L, 2015363072L, 2498756608L, 2321022976L,
      3278110720L, 3948019712L, 401014784L, 1100578816L, 603996160L, 4060094464L, 1459679232L, 1635801088L,
      3560989696L, 2854277632L, 871409408L, 3017292160L, 1931784256L, 2473752608L, 2199360752L, 3418425944L,
      3882124132L, 424856402L, 2147483648L, 3221225472L, 536870912L, 268435456L, 2281701376L, 1140850688L,
      1711276032L, 1996488704L, 4152360960L, 3082813440L, 3617587200L, 2815426560L, 1596456960L, 3818127360L,
      961413120L, 2497904640L, 3459874816L, 596951040L, 424550400L, 2229473280L, 1178142720L, 1737786368L,
      2135836160L, 4091766528L, 2981756800L, 3495179200L, 2834207136L, 1412677840L, 4002521256L, 868274260L,
      2443225326L, 2147483648L, 1073741824L, 3758096384L, 1342177280L, 3355443200L, 469762048L, 301989888L,
      788529152L, 1317011456L, 3695181824L, 870318080L, 1544552448L, 4063756288L, 2132017152L, 2259812352L,
      3225878528L, 568623104L, 1931198464L, 3165364224L, 2741178368L, 3042899968L, 2621441024L, 3554676224L,
      202376448L, 976751744L, 1662255552L, 2494693664L, 4014408432L, 1868858600L, 2942029252L, 2404098878L,
      2147483648L, 1073741824L, 3758096384L, 805306368L, 2013265920L, 1409286144L, 2382364672L, 218103808L,
      3397386240L, 3896508416L, 4200595456L, 2505048064L, 2832728064L, 421265408L, 2762342400L, 3579379712L,
      1222475776L, 688275456L, 3702071296L, 2171949056L, 3337762816L, 605701120L, 370093568L, 1764512512L,
      1018150784L, 2975596864L, 3200648928L, 1879638992L, 2550500136L, 1679444932L, 4128188230L, 2147483648L,
      3221225472L, 2684354560L, 2415919104L, 939524096L, 469762048L, 3456106496L, 285212672L, 2122317824L,
      4206886912L, 3177185280L, 1563426816L, 682098688L, 1742995456L, 904790016L, 2868314112L, 628850688L,
      3507503104L, 3736707072L, 1792913408L, 2238896128L, 1092881408L, 3868068352L, 1992755456L, 1263764352L,
      1345601984L, 2553785568L, 2350559504L, 4129382376L, 219169708L, 2964955606L, 2147483648L, 3221225472L,
      3758096384L, 1342177280L, 1476395008L, 3556769792L, 436207616L, 1895825408L, 3984588800L, 3695181824L,
      2455764992L, 3111124992L, 2245525504L, 1143209984L, 2720923648L, 4112580608L, 2945482752L, 2036940800L,
      1709039616L, 337334272L, 4196923392L, 554519552L, 3046370816L, 139089152L, 2289008000L, 3359637824L,
      1751125920L, 2557477392L, 811076440L, 1281622148L, 709757062L, 2147483648L, 1073741824L, 1610612736L,
      2415919104L, 2281701376L, 3825205248L, 1442840576L, 754974720L, 3581935616L, 3955228672L, 1944059904L,
      3754950656L, 3455582208L, 2264137728L, 3327787008L, 2752315392L, 909082624L, 3172352000L, 1568858112L,
      264810496L, 635181056L, 4074128384L, 409134592L, 1830336768L, 3047428224L, 2078427712L, 4225295200L,
      1002814416L, 2616434136L, 2881488124L, 333448286L, 2147483648L, 3221225472L, 1610612736L, 3489660928L,
      671088640L, 2885681152L, 3992977408L, 3472883712L, 947912704L, 3862953984L, 2447376384L, 254803968L,
      1486356480L, 913571840L, 3119120384L, 2736455680L, 3064168448L, 4182228992L, 2170822656L, 1164087296L,
      661125120L, 4134800384L, 3655992832L, 1931152640L, 2661515904L, 1430768320L, 1868836576L, 2321718512L,
      535296904L, 271843940L, 1208618782L, 2147483648L, 1073741824L, 536870912L, 1879048192L, 2550136832L,
      738197504L, 1711276032L, 1627389952L, 1350565888L, 3921674240L, 3059744768L, 1253048320L, 110624768L,
      805568512L, 3087138816L, 1543962624L, 4262035456L, 1292025856L, 914776064L, 2294681600L, 3873769472L,
      2742983680L, 2968741376L, 2058398464L, 3197790592L, 1811939392L, 1174405152L, 285212784L, 3363831960L,
      3317694508L, 3495952486L, 2147483648L, 3221225472L, 2684354560L, 268435456L, 134217728L, 1811939328L,
      2181038080L, 1090519040L, 3816816640L, 4089446400L, 4225761280L, 2521825280L, 374865920L, 1448869888L,
      3058827264L, 1180499968L, 3193077760L, 710656000L, 1012572160L, 1801441280L, 3755251712L, 2559634432L,
      607856128L, 248088832L, 845300608L, 1485892800L, 2218469024L, 516524304L, 979518344L, 881913004L,
      104539682L, 2147483648L, 3221225472L, 3758096384L, 4026531840L, 2818572288L, 3690987520L, 1308622848L,
      1459617792L, 2172649472L, 1119879168L, 2686451712L, 1378877440L, 4208459776L, 634126336L, 1773010944L,
      1023344640L, 3170009088L, 4243701760L, 1559420928L, 217477120L, 4109670400L, 3506105344L, 3136446976L,
      2281607936L, 998233472L, 3309158592L, 2606555360L, 2533978352L, 1636178088L, 2999659740L, 136348238L,
      2147483648L, 1073741824L, 3758096384L, 4026531840L, 3355443200L, 3690987520L, 1912602624L, 184549376L,
      4236247040L, 2705326080L, 325058560L, 999292928L, 362283008L, 2895380480L, 2065039360L, 4141547520L,
      1559920640L, 2953232384L, 671457280L, 738357248L, 3120850944L, 3607585792L, 2391399936L, 2856918272L,
      4025460608L, 2597545024L, 117432032L, 2533498352L, 1854744392L, 1514251420L, 669810322L, 2147483648L,
      3221225472L, 2684354560L, 268435456L, 4160749568L, 1006632960L, 570425344L, 1358954496L, 461373440L,
      3485466624L, 706740224L, 1708130304L, 232259584L, 2312896512L, 2010251264L, 4108124160L, 3059580928L,
      1444855808L, 2784993280L, 2903232512L, 2575702016L, 2395679744L, 3383671296L, 2518446336L, 100263808L,
      3171626176L, 1636743840L, 2999742736L, 3953256312L, 3340184828L, 511490690L, 2147483648L, 1073741824L,
      2684354560L, 2952790016L, 939524096L, 2080374784L, 2852126720L, 922746880L, 2407530496L, 843055104L,
      4179623936L, 479199232L, 2048393216L, 3738435584L, 456261632L, 240058368L, 4079583232L, 2610741248L,
      3448840192L, 2425401344L, 1209030656L, 635393024L, 112650752L, 1997155584L, 797643648L, 2185466944L,
      3240610464L, 1620745648L, 3491449784L, 3923558460L, 2494636042L, 2147483648L, 3221225472L, 1610612736L,
      1879048192L, 939524096L, 2751463424L, 2516582400L, 2600468480L, 2709520384L, 281018368L, 1222639616L,
      2624585728L, 860356608L, 204210176L, 1001783296L, 2952986624L, 1476493312L, 3556884480L, 2919292928L,
      1057132544L, 931289088L, 2344774656L, 3915548160L, 2360361728L, 2074682240L, 2422108608L, 150916384L,
      3157209264L, 1672965848L, 1677721612L, 4127195142L, 2147483648L, 1073741824L, 3758096384L, 1342177280L,
      3892314112L, 3288334336L, 973078528L, 2164260864L, 3246391296L, 541065216L, 1893728256L, 2570059776L,
      1555562496L, 1724645376L, 3872260096L, 650969088L, 114130944L, 1993097216L, 4006486016L, 2999930880L,
      3570321408L, 869094400L, 357420544L, 328062208L, 1705774464L, 2327818688L, 957710176L, 3966905072L,
      3755533400L, 3401560516L, 3642064750L, 2147483648L, 1073741824L, 536870912L, 4026531840L, 3355443200L,
      1811939328L, 3456106496L, 3942645760L, 2290089984L, 1279262720L, 1071644672L, 579862528L, 3830972416L,
      2212233216L, 3577085952L, 2868969472L, 2826993664L, 3158556672L, 4158857216L, 1318170624L, 710621184L,
      1759489024L, 1572086272L, 3879743744L, 2539683712L, 2664647232L, 330871136L, 3444555632L, 4285426904L,
      3285975044L, 4113956866L, 2147483648L, 1073741824L, 536870912L, 3489660928L, 2013265920L, 2214592512L,
      3456106496L, 3405774848L, 3296722944L, 3997171712L, 446693376L, 3161456640L, 1799880704L, 3577479168L,
      1994784768L, 2923495424L, 983597056L, 1819492352L, 323608576L, 1363021824L, 3102029824L, 1698835456L,
      4263744000L, 2184247552L, 166300288L, 3981238720L, 3551302944L, 2961012976L, 2294565272L, 745750532L,
      860479490L, 2147483648L, 1073741824L, 3758096384L, 2415919104L, 1744830464L, 3556769792L, 570425344L,
      4278190080L, 1484783616L, 3451912192L, 253755392L, 1641021440L, 1344798720L, 1208221696L, 1688076288L,
      4211146752L, 4068704256L, 1992441856L, 497131520L, 2266189824L, 629704704L, 454556672L, 1662476800L,
      521549568L, 3373644928L, 2752956224L, 3683999904L, 1121267728L, 2922723960L, 298057732L, 2847801358L,
      2147483648L, 1073741824L, 536870912L, 1879048192L, 3087007744L, 2751463424L, 1577058304L, 620756992L,
      2675965952L, 3300917248L, 245366784L, 3968860160L, 2209873920L, 1060372480L, 1968570368L, 1466236928L,
      3629023232L, 4106272768L, 2527223808L, 949178368L, 1706792960L, 3191211008L, 3033859584L, 3064366848L,
      1231864960L, 3700449600L, 465065056L, 3946061456L, 2471904184L, 3597051204L, 433009250L, 2147483648L,
      3221225472L, 1610612736L, 805306368L, 2281701376L, 3422552064L, 3724541952L, 2734686208L, 3045064704L,
      4206886912L, 2170552320L, 1099956224L, 567803904L, 295436288L, 2557870080L, 1438842880L, 2330034176L,
      676380672L, 2637832192L, 1724854272L, 3872225280L, 2798488576L, 2261603840L, 2529962752L, 248489344L,
      1523447360L, 3503185760L, 4191042160L, 1699639256L, 51167244L, 3828097030L, 2147483648L, 1073741824L,
      2684354560L, 805306368L, 134217728L, 2885681152L, 2785017856L, 788529152L, 1115684864L, 2218786816L,
      4225761280L, 3788505088L, 2423783424L, 960233472L, 2769682432L, 177274880L, 2300215296L, 1823260672L,
      3331203072L, 2122297344L, 443947008L, 1879145472L, 2818812416L, 2617270528L, 2919323520L, 2197916480L,
      3833713632L, 2873248240L, 3110105560L, 1704049668L, 1805355530L, 2147483648L, 3221225472L, 536870912L,
      2952790016L, 2818572288L, 1006632960L, 1979711488L, 3607101440L, 662700032L, 4013948928L, 48234496L,
      202375168L, 2677538816L, 2323382272L, 2180382720L, 1074987008L, 1637384192L, 3514744832L, 2020909056L,
      1146351616L, 855201792L, 3844971520L, 3263970816L, 763120896L, 779572096L, 592620608L, 3178807392L,
      913286384L, 3060757592L, 4134378508L, 2523676162L, 2147483648L, 3221225472L, 1610612736L, 4026531840L,
      1207959552L, 603979776L, 2583691264L, 486539264L, 3061841920L, 2202009600L, 3760193536L, 2985295872L,
      1754791936L, 4108058624L, 37617664L, 2704211968L, 2426896384L, 3102785536L, 1813553152L, 3198111744L,
      2258454528L, 2862605312L, 882848256L, 1671346432L, 1344273024L, 3655113408L, 2629757664L, 4134351024L,
      2726803608L, 805535436L, 671209702L, 2147483648L, 3221225472L, 2684354560L, 4026531840L, 3892314112L,
      2751463424L, 2717908992L, 1929379840L, 729808896L, 2252341248L, 2422210560L, 3096444928L, 3165126656L,
      4002676736L, 1957560320L, 4220715008L, 3744104448L, 1020772352L, 2932711424L, 2483130368L, 3925870592L,
      654445568L, 1635978752L, 1363183872L, 434162048L, 1305685568L, 122313888L, 3494224720L, 1483051832L,
      2912291852L, 388828682L, 2147483648L, 3221225472L, 2684354560L, 4026531840L, 3892314112L, 335544320L,
      436207616L, 2566914048L, 3162505216L, 4022337536L, 2468347904L, 3698327552L, 3197632512L, 2332819456L,
      546177024L, 2966355968L, 162299904L, 96256000L, 3820429312L, 1970311168L, 1243170816L, 2160980992L,
      1102002688L, 3787361024L, 297031296L, 4168248000L, 3969606880L, 4128076528L, 1846410456L, 3524176588L,
      1007437034L, 2147483648L, 3221225472L, 3758096384L, 4026531840L, 939524096L, 4093640704L, 1174405120L,
      520093696L, 1535115264L, 2227175424L, 1063256064L, 1244659712L, 1288175616L, 4087087104L, 4192600064L,
      368246784L, 3056304128L, 644857856L, 2949570560L, 3281833984L, 568629248L, 300989440L, 3358199296L,
      3446539008L, 2991523200L, 1482523840L, 1157940512L, 3741409648L, 3145798680L, 1958968332L, 123923982L };

}
